<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TOKe Ultimate - Debug Mode</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        body { background-color: #0F172A; color: #E2E8F0; font-family: 'Inter', system-ui, sans-serif; }
        .panel { background: rgba(30, 41, 59, 0.5); border: 1px solid rgba(148, 163, 184, 0.1); backdrop-filter: blur(12px); border-radius: 0.75rem; }
        .th-cell { @apply px-4 py-3 text-xs font-semibold text-slate-400 uppercase tracking-wider text-right; }
        .td-cell { @apply px-4 py-3 text-sm border-t border-slate-700/50 text-right; }
    </style>
</head>
<body class="min-h-screen p-4 lg:p-8" x-data="dashboardApp()">

    <header class="max-w-7xl mx-auto mb-8">
        <h1 class="text-3xl font-bold text-cyan-400">TOKe ULTIMATE <span class="text-white text-sm bg-red-600 px-2 py-1 rounded ml-2">DEBUG MODE</span></h1>
        <p class="text-slate-500 text-sm mt-1">Realtime Publisher Statistics</p>
    </header>

    <!-- ERROR BOX (PENTING: Ini akan menampilkan pesan error asli) -->
    <div x-show="errorMessage" class="max-w-7xl mx-auto mb-6 p-6 bg-red-900/50 border-2 border-red-500 text-white rounded-lg shadow-lg">
        <h3 class="font-bold text-lg mb-2">⚠️ TERJADI ERROR:</h3>
        <p class="font-mono text-sm bg-black/50 p-3 rounded" x-text="errorMessage"></p>
        <p class="text-sm mt-2 text-red-200">Silakan kirim pesan error di atas kepada saya.</p>
    </div>

    <!-- KPI Cards -->
    <section class="max-w-7xl mx-auto mb-8 grid grid-cols-2 lg:grid-cols-4 gap-4">
        <div class="panel p-5 border-l-4 border-emerald-500">
            <div class="text-xs text-slate-400 uppercase">Total Revenue</div>
            <div class="text-2xl font-bold text-white mt-1" x-text="formatCurrency(totalRevenue)"></div>
        </div>
        <div class="panel p-5 border-l-4 border-blue-500">
            <div class="text-xs text-slate-400 uppercase">Impressions</div>
            <div class="text-2xl font-bold text-white mt-1" x-text="formatNumber(totalImpressions)"></div>
        </div>
    </section>

    <!-- Tables -->
    <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Placement -->
        <div class="panel h-[500px] flex flex-col">
            <div class="px-6 py-4 bg-slate-800/30 border-b border-slate-700 font-bold text-cyan-400">BY PLACEMENT</div>
            <div class="overflow-auto flex-1">
                <table class="w-full">
                    <thead class="bg-slate-900/50 sticky top-0"><tr><th class="th-cell text-left">ID</th><th class="th-cell">Rev ($)</th></tr></thead>
                    <tbody>
                        <template x-for="item in data.placement" :key="item.placement_id">
                            <tr><td class="td-cell text-left text-blue-300" x-text="item.placement_id"></td><td class="td-cell font-bold text-emerald-400" x-text="formatCurrency(item.revenue)"></td></tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>
        <!-- Country -->
        <div class="panel h-[500px] flex flex-col">
            <div class="px-6 py-4 bg-slate-800/30 border-b border-slate-700 font-bold text-purple-400">BY COUNTRY</div>
            <div class="overflow-auto flex-1">
                <table class="w-full">
                    <thead class="bg-slate-900/50 sticky top-0"><tr><th class="th-cell text-left">Country</th><th class="th-cell">Rev ($)</th></tr></thead>
                    <tbody>
                        <template x-for="item in data.country" :key="item.country">
                            <tr><td class="td-cell text-left font-bold" x-text="item.country"></td><td class="td-cell font-bold text-emerald-400" x-text="formatCurrency(item.revenue)"></td></tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        function dashboardApp() {
            return {
                data: { date: [], placement: [], country: [] },
                errorMessage: null,
                get totalRevenue() { return this.data.date.reduce((acc, cur) => acc + cur.revenue, 0); },
                get totalImpressions() { return this.data.date.reduce((acc, cur) => acc + cur.impressions, 0); },

                init() { this.fetchAll(); },

                async fetchAll() {
                    this.errorMessage = null;
                    const end = new Date().toISOString().split('T')[0];
                    const start = new Date(new Date().setDate(new Date().getDate() - 7)).toISOString().split('T')[0];

                    const fetchData = async (groupBy, targetKey) => {
                        try {
                            // Request ke backend
                            const res = await fetch(`/api/stats?start_date=${start}&end_date=${end}&group_by=${groupBy}`);
                            
                            // Cek jika HTML yang kembali (bukan JSON) -> Tanda Salah Folder
                            const contentType = res.headers.get("content-type");
                            if (contentType && contentType.indexOf("application/json") === -1) {
                                throw new Error("Server membalas dengan HTML, bukan JSON. Cek struktur folder 'functions/api/stats.js' di GitHub Anda.");
                            }

                            const json = await res.json();

                            // Jika backend kirim sinyal error, tampilkan error aslinya!
                            if (json.status === 'error') {
                                throw new Error(`Server Error: ${json.error}`);
                            }
                            
                            this.data[targetKey] = json.items || [];
                        } catch (e) {
                            console.error(e);
                            // Tampilkan pesan error spesifik ke layar
                            this.errorMessage = `Gagal pada ${groupBy}: ${e.message}`;
                        }
                    };

                    // Jalankan Request
                    fetchData('date', 'date');
                    fetchData('placement', 'placement');
                    fetchData('country', 'country');
                },

                formatCurrency(val) { return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(val); },
                formatNumber(val) { return new Intl.NumberFormat('en-US').format(val); }
            }
        }
    </script>
</body>
</html>
